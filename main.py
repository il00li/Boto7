import telebot
from telebot import types
import json
import os
import random
import string
from datetime import datetime, timedelta

# ุฅุนุฏุงุฏุงุช ุงูุจูุช
BOT_TOKEN = os.getenv('BOT_TOKEN', '8324471840:AAFqTHWy4-FZFIHGusm5RWk1Y240cV32SCw')
ADMIN_ID = int(os.getenv('ADMIN_ID', 6689435577))
CHANNEL_USERNAME = os.getenv('CHANNEL_USERNAME', '@iIl337')
MAIN_CHANNEL = os.getenv('MAIN_CHANNEL', '@GRABOT7')
DEVELOPER_USERNAME = os.getenv('DEVELOPER_USERNAME', '@OlIiIl7')

# ูุณุงุฑุงุช ูููุงุช ุงูุชุฎุฒูู
USERS_FILE = "users.json"
SEARCH_TYPES_FILE = "search_types.json"
INVITES_FILE = "invites.json"

# ูุธุงุฆู ุงูุชุฎุฒูู
def ensure_file_exists(file_path):
    """ุชุฃูุฏ ูู ูุฌูุฏ ุงููููุ ูุฅูุดุงุฆู ุฅุฐุง ูู ููู ููุฌูุฏุงู"""
    if not os.path.exists(file_path):
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump({}, f, ensure_ascii=False, indent=4)

def read_json(file_path):
    """ูุฑุงุกุฉ ููู JSON"""
    ensure_file_exists(file_path)
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except (json.JSONDecodeError, FileNotFoundError):
        return {}

def write_json(file_path, data):
    """ูุชุงุจุฉ ุจูุงูุงุช ุฅูู ููู JSON"""
    ensure_file_exists(file_path)
    with open(file_path, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

# ุฏูุงู ูุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
def get_user(user_id):
    """ุงูุญุตูู ุนูู ุจูุงูุงุช ูุณุชุฎุฏู"""
    users = read_json(USERS_FILE)
    user_id_str = str(user_id)
    return users.get(user_id_str, {})

def save_user(user_id, user_data):
    """ุญูุธ ุจูุงูุงุช ูุณุชุฎุฏู"""
    users = read_json(USERS_FILE)
    user_id_str = str(user_id)
    users[user_id_str] = user_data
    write_json(USERS_FILE, users)

def get_all_users():
    """ุงูุญุตูู ุนูู ุฌููุน ุงููุณุชุฎุฏููู"""
    return read_json(USERS_FILE)

def update_user_subscription(user_id, days=30):
    """ุชุญุฏูุซ ุงุดุชุฑุงู ุงููุณุชุฎุฏู"""
    user = get_user(user_id)
    if not user:
        user = {}
    
    subscription_end = datetime.now() + timedelta(days=days)
    user['subscription_end'] = subscription_end.isoformat()
    user['is_banned'] = False
    
    save_user(user_id, user)

def check_subscription(user_id):
    """ุงูุชุญูู ูู ุตูุงุญูุฉ ุงุดุชุฑุงู ุงููุณุชุฎุฏู"""
    user = get_user(user_id)
    if not user or user.get('is_banned', False):
        return False
    
    subscription_end = user.get('subscription_end')
    if not subscription_end:
        return False
    
    try:
        end_date = datetime.fromisoformat(subscription_end)
        return end_date > datetime.now()
    except (ValueError, TypeError):
        return False

# ุฏูุงู ูุฃููุงุน ุงูุจุญุซ
def get_search_type(user_id):
    """ุงูุญุตูู ุนูู ููุน ุงูุจุญุซ ูููุณุชุฎุฏู"""
    search_types = read_json(SEARCH_TYPES_FILE)
    user_id_str = str(user_id)
    return search_types.get(user_id_str, 'illustration')

def set_search_type(user_id, search_type):
    """ุชุนููู ููุน ุงูุจุญุซ ูููุณุชุฎุฏู"""
    search_types = read_json(SEARCH_TYPES_FILE)
    user_id_str = str(user_id)
    search_types[user_id_str] = search_type
    write_json(SEARCH_TYPES_FILE, search_types)

# ุฏูุงู ูุฅุฏุงุฑุฉ ุงูุฏุนูุงุช
def get_invite_code(user_id):
    """ุงูุญุตูู ุนูู ููุฏ ุงูุฏุนูุฉ ูููุณุชุฎุฏู"""
    user = get_user(user_id)
    return user.get('invite_code')

def set_invite_code(user_id, invite_code):
    """ุชุนููู ููุฏ ุงูุฏุนูุฉ ูููุณุชุฎุฏู"""
    user = get_user(user_id)
    if not user:
        user = {}
    
    user['invite_code'] = invite_code
    save_user(user_id, user)

def increment_invite_count(user_id):
    """ุฒูุงุฏุฉ ุนุฏุงุฏ ุงูุฏุนูุงุช ูููุณุชุฎุฏู"""
    user = get_user(user_id)
    if not user:
        user = {}
    
    current_count = user.get('invited_count', 0)
    user['invited_count'] = current_count + 1
    save_user(user_id, user)
    
    # ุฅุฐุง ูุตู ุนุฏุฏ ุงูุฏุนูุงุช ุฅูู 10ุ ุชูุนูู ุงูุงุดุชุฑุงู
    if user['invited_count'] >= 10:
        update_user_subscription(user_id, 30)
    
    return user['invited_count']

def add_invite_record(invite_code, owner_id, used_by):
    """ุฅุถุงูุฉ ุณุฌู ุฏุนูุฉ"""
    invites = read_json(INVITES_FILE)
    invite_id = str(len(invites) + 1)
    invites[invite_id] = {
        'invite_code': invite_code,
        'owner_id': owner_id,
        'used_by': used_by,
        'created_at': datetime.now().isoformat()
    }
    write_json(INVITES_FILE, invites)

def find_user_by_invite_code(invite_code):
    """ุงูุจุญุซ ุนู ูุณุชุฎุฏู ุจูุงุณุทุฉ ููุฏ ุงูุฏุนูุฉ"""
    users = get_all_users()
    for user_id, user_data in users.items():
        if user_data.get('invite_code') == invite_code:
            return int(user_id)
    return None

# ูุธุงุฆู ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ
def is_subscribed(bot, user_id, channel_username):
    try:
        chat_member = bot.get_chat_member(channel_username.replace('@', ''), user_id)
        return chat_member.status in ['member', 'administrator', 'creator']
    except:
        return False

def generate_invite_code(length=10):
    characters = string.ascii_letters + string.digits
    return ''.join(random.choice(characters) for _ in range(length))

# ูุธุงุฆู ููุญุฉ ุงูููุงุชูุญ
def main_menu_keyboard():
    keyboard = types.InlineKeyboardMarkup(row_width=2)
    
    keyboard.add(
        types.InlineKeyboardButton("ุจุฏุก ุงูุจุญุซ ๐ซ", callback_data="start_search"),
        types.InlineKeyboardButton("ููุน ุงูุจุญุซ ๐", callback_data="search_type"),
        types.InlineKeyboardButton("ูุนูููุงุช ๐ชป", callback_data="info"),
        types.InlineKeyboardButton("ุงุดุชุฑุงู ูุฌุงูู ๐๏ธ", callback_data="free_subscription")
    )
    
    return keyboard

def search_type_keyboard(selected_type=None):
    keyboard = types.InlineKeyboardMarkup(row_width=1)
    
    types_list = [
        ("Illustration | ุฑุณููุงุช", "illustration"),
        ("Photo | ุตูุฑ", "photo"),
        ("Video | ููุฏูู", "video")
    ]
    
    for name, callback in types_list:
        if selected_type == callback:
            name = f"๐ช {name}"
        keyboard.add(types.InlineKeyboardButton(name, callback_data=f"set_type_{callback}"))
    
    keyboard.add(types.InlineKeyboardButton("ุฑุฌูุน", callback_data="back_to_main"))
    
    return keyboard

def subscription_keyboard(user_id):
    keyboard = types.InlineKeyboardMarkup(row_width=2)
    
    keyboard.add(
        types.InlineKeyboardButton("ุทูุจ ุงูุงุดุชุฑุงู ูู ุงููุทูุฑ", url=f"tg://user?id={DEVELOPER_USERNAME.replace('@', '')}"),
        types.InlineKeyboardButton("ุงุดุชุฑุงู ูุฌุงูู ๐๏ธ", callback_data="free_subscription"),
        types.InlineKeyboardButton("ุชุญูู ๐", callback_data="check_subscription")
    )
    
    return keyboard

def force_subscribe_keyboard():
    keyboard = types.InlineKeyboardMarkup()
    
    keyboard.add(
        types.InlineKeyboardButton("ุงุดุชุฑู ูู ุงูููุงุฉ", url=f"https://t.me/{CHANNEL_USERNAME.replace('@', '')}"),
        types.InlineKeyboardButton("ุชุญูู ๐", callback_data="check_subscription")
    )
    
    return keyboard

def admin_keyboard():
    keyboard = types.InlineKeyboardMarkup(row_width=2)
    
    keyboard.add(
        types.InlineKeyboardButton("ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฌููุน", callback_data="admin_broadcast"),
        types.InlineKeyboardButton("ุนุฑุถ ุงููุณุชุฎุฏููู", callback_data="admin_list_users"),
        types.InlineKeyboardButton("ุญุธุฑ ูุณุชุฎุฏู", callback_data="admin_ban_user"),
        types.InlineKeyboardButton("ุฑูุน ุญุธุฑ ูุณุชุฎุฏู", callback_data="admin_unban_user")
    )
    
    return keyboard

# ุชููุฆุฉ ุงูุจูุช
bot = telebot.TeleBot(BOT_TOKEN)

# ูุนุงูุฌุฉ ุงูุฃูุฑ /start
@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_id = message.from_user.id
    username = message.from_user.username
    full_name = message.from_user.full_name
    
    # ุญูุธ ุงููุณุชุฎุฏู ุฅุฐุง ูู ููู ููุฌูุฏุงู
    user_data = get_user(user_id)
    if not user_data:
        user_data = {
            'username': username,
            'full_name': full_name,
            'subscription_end': None,
            'is_banned': False,
            'invite_code': None,
            'invited_count': 0
        }
        save_user(user_id, user_data)
    
    # ูุนุงูุฌุฉ ุฑุงุจุท ุงูุฏุนูุฉ ุฅุฐุง ูุฌุฏ
    if len(message.text.split()) > 1:
        invite_code = message.text.split()[1]
        
        # ุงูุจุญุซ ุนู ุตุงุญุจ ููุฏ ุงูุฏุนูุฉ
        owner_id = find_user_by_invite_code(invite_code)
        if owner_id and owner_id != user_id:
            # ุฒูุงุฏุฉ ุนุฏุงุฏ ุงูุฏุนูุงุช ูุตุงุญุจ ุงูููุฏ
            new_count = increment_invite_count(owner_id)
            
            # ุฅุฑุณุงู ุฅุดุนุงุฑ ูุตุงุญุจ ุงูุฏุนูุฉ
            try:
                bot.send_message(owner_id, f"๐ ุงูุถู ุนุถู ุฌุฏูุฏ ุนุจุฑ ุฑุงุจุท ุงูุฏุนูุฉ ุงูุฎุงุต ุจู! ุงูุขู ูุฏูู {new_count} ุฏุนูุฉ.")
            except:
                pass
    
    # ุงูุชุญูู ูู ุงูุงุดุชุฑุงู ูู ุงูููุงุฉ
    if not is_subscribed(bot, user_id, CHANNEL_USERNAME):
        bot.send_message(message.chat.id, 
                        "(๏ผใ๏ผผ)ใ\nุงุดุชุฑุงู ูู ุงูููุงุฉ ุนุจุฑ ุงูุฒุฑ ุจุงูุฃุณูู ุซู ุงุถุบุท ุนูู \"ุชุญูู ๐\"", 
                        reply_markup=force_subscribe_keyboard())
        return
    
    # ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุชุฑุญูุจ
    welcome_text = "(๏ผพโฝ๏ผพ)๏ผ \nุงุฎุชุฑ ููุน ุงูุจุญุซ ูู\" ููุน ุงูุจุญุซ ๐\" ูุงุจุฏุก ุงูุจุญุซ ุนุจุฑ \"ุจุฏุก ุงูุจุญุซ ๐ซ\"\n\nุงููุทูุฑ @OlIiIl7"
    bot.send_message(message.chat.id, welcome_text, reply_markup=main_menu_keyboard())

# ูุนุงูุฌุฉ ุงูุฃุฒุฑุงุฑ ุงูุฅููุงูู
@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    message_id = call.message.message_id
    
    # ุงูุชุญูู ูู ุงูุงุดุชุฑุงู ุฃููุงู
    if not is_subscribed(bot, user_id, CHANNEL_USERNAME) and call.data != "check_subscription":
        bot.answer_callback_query(call.id, "ูุฌุจ ุงูุงุดุชุฑุงู ูู ุงูููุงุฉ ุฃููุงู")
        return
    
    if call.data == "start_search":
        # ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุจุญุซ
        if not check_subscription(user_id):
            bot.answer_callback_query(call.id, "ููุณ ูุฏูู ุตูุงุญูุฉ ุงูุจุญุซ")
            bot.edit_message_text("(เธ'โ-'โ)เธ\nููุณ ูุฏูู ุตูุงุญูุฉ ุงูุจุญุซุ ุงููุฑ ุนูู ุงูุฒุฑ ุงุฏูุงุฉ ูุทูุจ ุงูุงุดุชุฑุงู", 
                                 chat_id, message_id, 
                                 reply_markup=subscription_keyboard(user_id))
            return
        
        # ุจุฏุก ุงูุจุญุซ ุจูุงุกู ุนูู ุงูููุน ุงููุญุฏุฏ
        search_type = get_search_type(user_id)
        # ููุง ููููู ุฅุถุงูุฉ ููุทู ุงูุจุญุซ ุงููุนูู
        bot.answer_callback_query(call.id, f"ุณูุชู ุงูุจุญุซ ุนู {search_type}")
    
    elif call.data == "search_type":
        current_type = get_search_type(user_id)
        bot.edit_message_text("ุงุฎุชุฑ ููุน ุงูุจุญุซ:", chat_id, message_id, 
                             reply_markup=search_type_keyboard(current_type))
    
    elif call.data.startswith("set_type_"):
        search_type = call.data.split("_")[2]
        set_search_type(user_id, search_type)
        bot.answer_callback_query(call.id, f"ุชู ุงุฎุชูุงุฑ: {search_type}")
        bot.edit_message_reply_markup(chat_id, message_id, 
                                     reply_markup=search_type_keyboard(search_type))
    
    elif call.data == "back_to_main":
        welcome_text = "(๏ผพโฝ๏ผพ)๏ผ \nุงุฎุชุฑ ููุน ุงูุจุญุซ ูู\" ููุน ุงูุจุญุซ ๐\" ูุงุจุฏุก ุงูุจุญุซ ุนุจุฑ \"ุจุฏุก ุงูุจุญุซ ๐ซ\"\n\nุงููุทูุฑ @OlIiIl7"
        bot.edit_message_text(welcome_text, chat_id, message_id, 
                             reply_markup=main_menu_keyboard())
    
    elif call.data == "info":
        info_text = """
๐ | ุงูุจูุช ูุฏููุน ุ ููููู ุทูุจ ุงูุงุดุชุฑุงู ูู ุงููุทูุฑ @OlIiIl7
๐งก | ูููู ุงูุญุตูู ุนูู ุงูุงุดุชุฑุงู ุนู ุทุฑูู ุฑุงุจุท ุงูุฏุนูุฉ ุ ูู ุจุฏุนูุฉ 10 ุงุดุฎุงุต ููุญุตูู ุนูููุง
โค๏ธ | ุงู ููููู ุงูุญุตูู ุนูู ุงูููุญูุงุช ุงูุชู ุชู ุงูุจุญุซ ุนููุง ูู ุงูููุงุฉ @GRABOT7
๐ค | ุชุฑูุจู ุงูุชุญุฏูุซุงุช ุงููุงุฏูุฉ 
https://t.me/iIl337

- ููุงุฉ ุงูุงุดุชุฑุงู ุงูุงุฌุจุงุฑู
https://t.me/iIl337
        """
        bot.edit_message_text(info_text, chat_id, message_id, 
                             reply_markup=main_menu_keyboard())
    
    elif call.data == "free_subscription":
        # ุฅูุดุงุก ุฑุงุจุท ุฏุนูุฉ ูุฑูุฏ
        invite_code = get_invite_code(user_id)
        
        if not invite_code:
            invite_code = generate_invite_code()
            set_invite_code(user_id, invite_code)
        
        invite_link = f"https://t.me/{bot.get_me().username}?start={invite_code}"
        bot.edit_message_text(f"ุฑุงุจุท ุงูุฏุนูุฉ ุงูุฎุงุต ุจู:\n{invite_link}\n\nุงุฏุนู 10 ุฃุตุฏูุงุก ููุญุตูู ุนูู ุงุดุชุฑุงู ูุฌุงูู ููุฏุฉ ุดูุฑ!", 
                             chat_id, message_id, 
                             reply_markup=main_menu_keyboard())
    
    elif call.data == "check_subscription":
        if is_subscribed(bot, user_id, CHANNEL_USERNAME):
            welcome_text = "(๏ผพโฝ๏ผพ)๏ผ \nุงุฎุชุฑ ููุน ุงูุจุญุซ ูู\" ููุน ุงูุจุญุซ ๐\" ูุงุจุฏุก ุงูุจุญุซ ุนุจุฑ \"ุจุฏุก ุงูุจุญุซ ๐ซ\"\n\nุงููุทูุฑ @OlIiIl7"
            bot.edit_message_text(welcome_text, chat_id, message_id, 
                                 reply_markup=main_menu_keyboard())
        else:
            bot.answer_callback_query(call.id, "ูู ุชุดุชุฑู ูู ุงูููุงุฉ ุจุนุฏ")
    
    # ุฃูุงูุฑ ุงููุฏูุฑ
    elif call.data == "admin_panel" and user_id == ADMIN_ID:
        bot.edit_message_text("ููุญุฉ ุชุญูู ุงููุฏูุฑ", chat_id, message_id, 
                             reply_markup=admin_keyboard())
    
    elif call.data == "admin_list_users" and user_id == ADMIN_ID:
        users = get_all_users()
        users_text = "ูุงุฆูุฉ ุงููุณุชุฎุฏููู:\n\n"
        for uid, user_data in users.items():
            users_text += f"ID: {uid}, Name: {user_data.get('full_name', 'N/A')}, Username: @{user_data.get('username', 'N/A')}\n"
        
        bot.edit_message_text(users_text, chat_id, message_id, 
                             reply_markup=admin_keyboard())

# ุฃูุงูุฑ ุงููุฏูุฑ
@bot.message_handler(commands=['admin'], func=lambda message: message.from_user.id == ADMIN_ID)
def admin_panel(message):
    bot.send_message(message.chat.id, "ููุญุฉ ุชุญูู ุงููุฏูุฑ", reply_markup=admin_keyboard())

if __name__ == "__main__":
    print("Bot is running...")
    bot.infinity_polling()
